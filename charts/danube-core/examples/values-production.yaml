# Production configuration with persistence and resource limits
# Suitable for production deployments with high availability

global:
  clusterName: "danube-prod"

broker:
  replicaCount: 3
  image:
    repository: ghcr.io/danube-messaging/danube-broker
    tag: v0.7.2
    pullPolicy: IfNotPresent
  config:
    existingConfigMap: "danube-broker-config"
    fileName: "danube_broker.yml"
  persistence:
    enabled: true
    size: 50Gi
    storageClass: "fast-ssd"
  resources:
    requests:
      memory: "2Gi"
      cpu: "1000m"
    limits:
      memory: "4Gi"
      cpu: "2000m"
  externalAccess:
    enabled: true
    type: ClusterIP
    advertisedAddrTemplate: '$(POD_NAME).{{ include "danube-core.broker.headless" . }}.$(POD_NAMESPACE).svc.cluster.local:$(ADVERTISED_PORT)'
    advertisedPort: 6650
    # Proxy mode: external clients connect via ingress, broker identity is internal headless DNS.
    # The client sends x-danube-broker-url header; nginx hashes it to the correct backend pod.
    connectUrl: "danube.example.com:443"

etcd:
  replicaCount: 3
  image:
    repository: quay.io/coreos/etcd
    tag: v3.5.9
    pullPolicy: IfNotPresent
  persistence:
    enabled: true
    size: 10Gi
    storageClass: "fast-ssd"
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

prometheus:
  enabled: true
  serviceAccount:
    create: true
  rbac:
    create: true
  resources:
    requests:
      memory: "512Mi"
      cpu: "500m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
    # Hash-based sticky routing: requests with the same x-danube-broker-url
    # header are consistently routed to the same backend broker pod.
    nginx.ingress.kubernetes.io/upstream-hash-by: "$http_x_danube_broker_url"
  hosts:
    - host: danube.example.com
      paths:
        - path: /
          pathType: ImplementationSpecific
          servicePort: client
  tls:
    - secretName: danube-tls
      hosts:
        - danube.example.com
