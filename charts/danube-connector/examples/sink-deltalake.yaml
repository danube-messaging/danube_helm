# Delta Lake Sink Connector
# Install: helm install deltalake-sink danube/danube-connector -n danube -f sink-deltalake.yaml

image:
  repository: ghcr.io/danube-messaging/danube-sink-deltalake
  tag: "latest"

env:
  CONNECTOR_CONFIG_PATH: /etc/connector.toml
  DANUBE_SERVICE_URL: "http://danube-core-broker:6650"
  CONNECTOR_NAME: "deltalake-sink"
  S3_ENDPOINT: "http://minio:9000"
  RUST_LOG: "info,danube_sink_deltalake=debug"

secretEnv:
  AWS_ACCESS_KEY_ID: "minioadmin"
  AWS_SECRET_ACCESS_KEY: "minioadmin"

config:
  inline: |
    danube_service_url = "http://danube-core-broker:6650"
    connector_name = "deltalake-sink"
    metrics_port = 9090

    [deltalake]
    storage_backend = "s3"
    s3_region = "us-east-1"
    s3_endpoint = "http://minio:9000"
    s3_allow_http = true
    batch_size = 100
    flush_interval_ms = 3000

    [[deltalake.topic_mappings]]
    topic = "/default/events"
    subscription = "deltalake-sink-sub"
    delta_table_path = "s3://delta-tables/events"
    write_mode = "append"
    include_danube_metadata = true
    expected_schema_subject = "events-schema-v1"
    field_mappings = [
        { json_path = "event_type", column = "event_type", data_type = "Utf8", nullable = false },
        { json_path = "user_id", column = "user_id", data_type = "Utf8", nullable = false },
        { json_path = "timestamp", column = "timestamp", data_type = "Utf8", nullable = false },
        { json_path = "product", column = "product", data_type = "Utf8", nullable = true },
        { json_path = "amount", column = "amount", data_type = "Int64", nullable = true },
        { json_path = "currency", column = "currency", data_type = "Utf8", nullable = true },
    ]
